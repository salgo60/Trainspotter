<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Mina √•kta j√§rnv√§gar & lok</title>
<link rel="stylesheet" href="leaflet/leaflet.css">
<script src="leaflet/leaflet.js"></script>
<style>
html,body{height:100%;margin:0}
#map{height:100%;width:100%}
.legend,.infobox,.map-switcher{
  background:#fff;padding:8px;border-radius:8px;font-size:14px;
  box-shadow:0 2px 4px rgba(0,0,0,0.2)
}
.map-switcher{position:absolute;top:10px;left:10px;z-index:1000;
  display:flex;flex-direction:column;gap:5px}
.map-btn{background:#eee;border:none;border-radius:6px;padding:5px 8px;
  cursor:pointer;font-size:13px;display:flex;align-items:center;gap:4px}
.map-btn:hover{background:#ddd}.map-btn.active{background:#007bff;color:#fff}
.infobox{position:absolute;top:10px;right:10px;z-index:1000;
  text-align:right;line-height:1.4em;width:220px}
.infobox small{color:#555}
.infobox button{margin-top:5px;background:#007bff;color:#fff;border:none;
  padding:4px 8px;border-radius:5px;cursor:pointer}
.infobox button:hover{background:#0056b3}
.infobox select{width:100%;margin-top:5px}
#locoList{list-style:none;padding:0;margin:5px 0 0;text-align:left}
#locoList li{background:#f5f5f5;margin-bottom:2px;padding:2px 4px;border-radius:4px}
#mapStatus{font-size:12px;color:#333;margin-top:4px;display:block}
</style>
</head>
<body>
<div id="map"></div>

<div class="map-switcher">
  <button class="map-btn active" data-map="railway">üöÜ Railway</button>
  <button class="map-btn" data-map="osm">üó∫Ô∏è OSM</button>
  <button class="map-btn" data-map="topo">üèîÔ∏è Topo</button>
  <button class="map-btn" data-map="sat">üõ∞Ô∏è Satellit</button>
</div>

<div class="infobox" id="infobox">
  <b>J√§rnv√§gskarta</b><br>
  Version: <span id="version">1.7</span><br>
  <small>Senast sparad: <span id="lastSaved">‚Äì</span></small><br>
  <button id="exportBtn">Exportera GeoJSON</button>
  <span id="mapStatus">Bakgrund: OpenRailwayMap (OK)</span>
  <hr>
  <b>√Ökta lok</b><br>
  <select id="lokSelector">
    <option value="">V√§lj loktyp...</option>
    <option value="Rc6">Rc6 ‚Äì el-lok</option>
    <option value="X2000">X2000 ‚Äì snabbt√•g</option>
    <option value="Y1">Y1 ‚Äì dieselmotorvagn</option>
    <option value="Td">Td ‚Äì v√§xellok</option>
    <option value="X55">X55 ‚Äì SJ 3000</option>
  </select>
  <button id="addLocoBtn">L√§gg till</button>
  <ul id="locoList"></ul>
</div>

<script>
const VERSION="1.7";
const map=L.map('map',{center:[60,16.5],zoom:6});
const statusEl=document.getElementById("mapStatus");

// Baslager
const baselayers={
  railway:L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png',{maxZoom:19}),
  osm:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}),
  topo:L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17}),
  sat:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{})
};
baselayers.railway.addTo(map);
baselayers.railway.on('tileerror',()=>{map.removeLayer(baselayers.railway);baselayers.osm.addTo(map);updateStatus("Bakgrund: OSM (fallback)");});

const railLayer=L.layerGroup().addTo(map);
const stationLayer=L.layerGroup().addTo(map);
const traveledLayer=L.layerGroup().addTo(map);

document.querySelectorAll(".map-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".map-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    Object.values(baselayers).forEach(l=>map.removeLayer(l));
    baselayers[btn.dataset.map].addTo(map);
    updateStatus("Bakgrund: "+btn.textContent.trim());
  });
});
function updateStatus(t){statusEl.textContent=t;}

// SPARQL ‚Äì stationer med Wikipedia l√§nk (sv)
async function fetchStations(){
  const query=`
  SELECT ?item ?itemLabel ?coord ?wp WHERE {
    ?item wdt:P31/wdt:P279* wd:Q55488;  # railway station
        wdt:P17 wd:Q34;              # Sweden
        wdt:P625 ?coord.
    OPTIONAL{
      ?wp schema:about ?item;
        schema:isPartOf <https://sv.wikipedia.org/>.
    }
    SERVICE wikibase:label{bd:serviceParam wikibase:language "sv,en".}
  }`;
  const url="https://query.wikidata.org/sparql?format=json&query="+encodeURIComponent(query);
  return (await fetch(url)).json();
}

// H√§mta banor (Sverige)
const overpassQuery=`[out:json][timeout:60];
  area["name"="Sweden"]->.a;
  (relation["railway"="rail"](area.a);way["railway"="rail"](area.a););
  out geom;`;
async function fetchOSM(){
  const r=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:overpassQuery});
  return (await r.json()).elements;
}

(async function init(){
  document.getElementById("version").textContent=VERSION;
  updateLastSaved();renderLocos();

  const [osmElements,stationData]=await Promise.all([fetchOSM(),fetchStations()]);
  const stations=stationData.results.bindings;
  const traveled=JSON.parse(localStorage.getItem('traveledLines')||'[]');

  osmElements.forEach(el=>{
    if(!el.geometry)return;
    const coords=el.geometry.map(p=>[p.lat,p.lon]);
    const color=traveled.includes(el.id)?'blue':'gray';
    const line=L.polyline(coords,{color,weight:3,opacity:0.7}).addTo(railLayer);
    line.osm_id=el.id;
    line.bindPopup(`<b>Bana (OSM ${el.id})</b><br><button onclick="markAsTraveled(${el.id})">Markera som √•kt</button>`);
  });

  stations.forEach(st=>{
    if(!st.coord)return;
    const [lat,lon]=st.coord.value.replace("Point(","").replace(")","").split(" ");
    const wp=st.wp?.value||null;
    const marker=L.circleMarker([lon,lat],{radius:4,color:'red',fillOpacity:0.8});
    marker.bindPopup(`
      <b>${st.itemLabel.value}</b><br>
      <a href="${st.item.value}" target="_blank">Wikidata</a><br>
      ${wp?`<a href="${wp}" target="_blank">Wikipedia (sv)</a>`:""}
    `);
    marker.addTo(stationLayer);
  });
})();

// Markera √•kt
function markAsTraveled(osmId){
  railLayer.eachLayer(l=>{
    if(l.osm_id===osmId){
      const latlngs=l.getLatLngs();
      L.polyline(latlngs,{color:'blue',weight:4}).addTo(traveledLayer);
      saveTraveled(osmId,latlngs);
    }
  });
  map.closePopup();
}
function saveTraveled(osmId,latlngs){
  let t=JSON.parse(localStorage.getItem('traveledLines')||'[]');
  let g=JSON.parse(localStorage.getItem('traveledGeo')||'{}');
  if(!t.includes(osmId)){
    t.push(osmId);g[osmId]=latlngs.map(c=>[c.lat,c.lng]);
    localStorage.setItem('traveledLines',JSON.stringify(t));
    localStorage.setItem('traveledGeo',JSON.stringify(g));
  }
  localStorage.setItem('lastSaved',new Date().toISOString().split("T")[0]);
  updateLastSaved();
}

// Export GeoJSON
document.getElementById("exportBtn").addEventListener("click",()=>{
  const g=JSON.parse(localStorage.getItem('traveledGeo')||'{}');
  const f=Object.keys(g).map(id=>({type:"Feature",properties:{osm_id:id},
    geometry:{type:"LineString",coordinates:g[id].map(c=>[c[1],c[0]])}}));
  const blob=new Blob([JSON.stringify({type:"FeatureCollection",features:f},null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`my_railways_${new Date().toISOString().split("T")[0]}.geojson`;a.click();
});

// Datum / lok
function updateLastSaved(){document.getElementById('lastSaved').textContent=localStorage.getItem('lastSaved')||'‚Äì';}
document.getElementById("addLocoBtn").addEventListener("click",()=>{
  const s=document.getElementById("lokSelector");const v=s.value;if(!v)return;
  let locos=JSON.parse(localStorage.getItem('myLocos')||'[]');
  if(!locos.includes(v)){locos.push(v);localStorage.setItem('myLocos',JSON.stringify(locos));renderLocos();}
  s.value="";
});
function renderLocos(){
  const list=document.getElementById("locoList");
  const locos=JSON.parse(localStorage.getItem('myLocos')||'[]');
  list.innerHTML=locos.length?locos.map(l=>`<li>${l}</li>`).join(''):"<li><i>Inga sparade √§nnu</i></li>";
}

// Legend
const legend=L.control({position:'bottomleft'});
legend.onAdd=function(){
  const div=L.DomUtil.create('div','legend');
  div.innerHTML=`<b>F√∂rklaring</b><br>
  <span style="background:gray"></span>Ej √•kt<br>
  <span style="background:blue"></span>√Ökt<br>
  <span style="background:red"></span>Station`;
  return div;
};
legend.addTo(map);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Mina √•kta j√§rnv√§gar & lok</title>
<link rel="stylesheet" href="leaflet/leaflet.css">
<script src="leaflet/leaflet.js"></script>
<style>
html,body{height:100%;margin:0}
#map{height:100%;width:100%}
.legend,.infobox,.map-switcher{
  background:#fff;padding:8px;border-radius:8px;font-size:14px;
  box-shadow:0 2px 4px rgba(0,0,0,0.2)
}
.map-switcher{position:absolute;top:10px;left:10px;z-index:1000;
  display:flex;flex-direction:column;gap:5px}
.map-btn{background:#eee;border:none;border-radius:6px;padding:5px 8px;
  cursor:pointer;font-size:13px;display:flex;align-items:center;gap:4px}
.map-btn:hover{background:#ddd}.map-btn.active{background:#007bff;color:#fff}
.infobox{position:absolute;top:10px;right:10px;z-index:1000;
  text-align:right;line-height:1.4em;width:220px}
.infobox small{color:#555}
.infobox button{margin-top:5px;background:#007bff;color:#fff;border:none;
  padding:4px 8px;border-radius:5px;cursor:pointer}
.infobox button:hover{background:#0056b3}
.infobox select{width:100%;margin-top:5px}
#locoList{list-style:none;padding:0;margin:5px 0 0;text-align:left}
#locoList li{background:#f5f5f5;margin-bottom:2px;padding:2px 4px;border-radius:4px}
#mapStatus{font-size:12px;color:#333;margin-top:4px;display:block}
.station-img{width:180px;border-radius:6px;margin-top:4px}
</style>
</head>
<body>
<div id="map"></div>

<div class="map-switcher">
  <button class="map-btn active" data-map="railway">üöÜ Railway</button>
  <button class="map-btn" data-map="osm">üó∫Ô∏è OSM</button>
  <button class="map-btn" data-map="topo">üèîÔ∏è Topo</button>
  <button class="map-btn" data-map="sat">üõ∞Ô∏è Satellit</button>
</div>

<div class="infobox" id="infobox">
  <b>J√§rnv√§gskarta</b><br>
  Version: <span id="version">1.8</span><br>
  <small>Senast sparad: <span id="lastSaved">‚Äì</span></small><br>
  <button id="exportBtn">Exportera GeoJSON</button>
  <span id="mapStatus">Bakgrund: OpenRailwayMap (OK)</span>
  <hr>
  <b>√Ökta lok</b><br>
  <select id="lokSelector">
    <option value="">V√§lj loktyp...</option>
    <option value="Rc6">Rc6 ‚Äì el-lok</option>
    <option value="X2000">X2000 ‚Äì snabbt√•g</option>
    <option value="Y1">Y1 ‚Äì dieselmotorvagn</option>
    <option value="Td">Td ‚Äì v√§xellok</option>
    <option value="X55">X55 ‚Äì SJ 3000</option>
  </select>
  <button id="addLocoBtn">L√§gg till</button>
  <ul id="locoList"></ul>
</div>

<script>
const VERSION="1.8";
const map=L.map('map',{center:[60,16.5],zoom:6});
const statusEl=document.getElementById("mapStatus");

// === Baslager ===
const baselayers={
  railway:L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png',{maxZoom:19}),
  osm:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}),
  topo:L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17}),
  sat:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{})
};
baselayers.railway.addTo(map);
baselayers.railway.on('tileerror',()=>{map.removeLayer(baselayers.railway);baselayers.osm.addTo(map);updateStatus("Bakgrund: OSM (fallback)");});

const railLayer=L.layerGroup().addTo(map);
const stationLayer=L.layerGroup().addTo(map);
const traveledLayer=L.layerGroup().addTo(map);

// === Kartv√§ljare ===
document.querySelectorAll(".map-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".map-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    Object.values(baselayers).forEach(l=>map.removeLayer(l));
    baselayers[btn.dataset.map].addTo(map);
    updateStatus("Bakgrund: "+btn.textContent.trim());
  });
});
function updateStatus(t){statusEl.textContent=t;}

// === H√§mta stationer (med bild och Wikipedia) ===
async function fetchStations(){
  const query=`
  SELECT ?item ?itemLabel ?coord ?wp ?bild WHERE {
    ?item wdt:P31/wdt:P279* wd:Q55488;
          wdt:P17 wd:Q34;
          wdt:P625 ?coord.
    OPTIONAL { ?item wdt:P18 ?bild. }
    OPTIONAL {
      ?wp schema:about ?item;
          schema:isPartOf <https://sv.wikipedia.org/>.
    }
    SERVICE wikibase:label { bd:serviceParam wikibase:la
